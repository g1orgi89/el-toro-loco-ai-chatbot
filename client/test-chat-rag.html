<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shrooms RAG Testing Interface | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–∞ —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π</title>
    <style>
        :root {
            --neon-green: #39FF14;
            --deep-purple: #8A2BE2;
            --dark-bg: #121212;
            --card-bg: #1e1e1e;
            --text-light: #E0E0E0;
            --text-white: #FFFFFF;
            --neon-pink: #FF6EC7;
            --cyan: #00FFF9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--deep-purple), var(--neon-green));
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.3);
        }

        .header h1 {
            color: var(--text-white);
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(57, 255, 20, 0.5);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: var(--card-bg);
            border: 2px solid var(--neon-green);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.2);
        }

        .panel h2 {
            color: var(--neon-green);
            margin-bottom: 15px;
            font-size: 1.5em;
            text-align: center;
            text-shadow: 0 0 10px var(--neon-green);
        }

        .test-scenarios {
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }

        .scenario-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .scenario-btn {
            background: linear-gradient(45deg, var(--deep-purple), var(--neon-pink));
            border: none;
            color: var(--text-white);
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            text-align: left;
        }

        .scenario-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 110, 199, 0.4);
        }

        .language-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .lang-btn {
            background: var(--card-bg);
            border: 2px solid var(--neon-green);
            color: var(--text-light);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lang-btn.active {
            background: var(--neon-green);
            color: var(--dark-bg);
            box-shadow: 0 0 15px var(--neon-green);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--neon-green);
            font-weight: 500;
        }

        .message-input {
            width: 100%;
            background: var(--dark-bg);
            border: 2px solid var(--deep-purple);
            color: var(--text-light);
            padding: 12px;
            border-radius: 10px;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.3);
        }

        .send-btn {
            width: 100%;
            background: linear-gradient(45deg, var(--neon-green), var(--cyan));
            border: none;
            color: var(--dark-bg);
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(57, 255, 20, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .response-area {
            height: 600px;
            overflow-y: auto;
            border: 2px solid var(--deep-purple);
            border-radius: 10px;
            padding: 15px;
            background: var(--dark-bg);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            animation: fadeIn 0.5s ease;
        }

        .message.user {
            background: linear-gradient(135deg, var(--deep-purple), var(--neon-pink));
            margin-left: 20%;
        }

        .message.assistant {
            background: linear-gradient(135deg, var(--card-bg), var(--neon-green));
            margin-right: 20%;
            border: 1px solid var(--neon-green);
        }

        .message-meta {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .rag-analysis {
            background: var(--card-bg);
            border: 1px solid var(--cyan);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .rag-analysis h4 {
            color: var(--cyan);
            margin-bottom: 8px;
        }

        .found-docs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .doc-item {
            background: var(--dark-bg);
            border: 1px solid var(--deep-purple);
            border-radius: 6px;
            padding: 8px;
        }

        .metrics {
            grid-column: 1 / -1;
            background: var(--card-bg);
            border: 2px solid var(--cyan);
            border-radius: 15px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 15px;
            background: var(--dark-bg);
            border-radius: 10px;
            border: 1px solid var(--neon-green);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--neon-green);
            display: block;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .scenario-buttons {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            color: var(--neon-green);
            font-style: italic;
        }

        .error {
            color: var(--neon-pink);
            background: rgba(255, 110, 199, 0.1);
            border: 1px solid var(--neon-pink);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçÑ Shrooms RAG Testing Interface</h1>
            <p>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π</p>
        </div>

        <!-- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ -->
        <div class="metrics">
            <div class="metric-item">
                <span class="metric-value" id="totalQueries">0</span>
                <span class="metric-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</span>
            </div>
            <div class="metric-item">
                <span class="metric-value" id="avgResponseTime">0ms</span>
                <span class="metric-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</span>
            </div>
            <div class="metric-item">
                <span class="metric-value" id="ragHitRate">0%</span>
                <span class="metric-label">RAG Hit Rate</span>
            </div>
            <div class="metric-item">
                <span class="metric-value" id="docsFound">0</span>
                <span class="metric-label">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ</span>
            </div>
        </div>

        <!-- –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ -->
        <div class="panel test-scenarios">
            <h2>üß™ –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏</h2>
            
            <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–∞ -->
            <div class="language-selector">
                <button class="lang-btn active" data-lang="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
                <button class="lang-btn" data-lang="en">üá∫üá∏ English</button>
                <button class="lang-btn" data-lang="es">üá™üá∏ Espa√±ol</button>
            </div>

            <div class="scenario-buttons">
                <button class="scenario-btn" data-scenario="wallet-connection">
                    üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ Xverse
                </button>
                <button class="scenario-btn" data-scenario="farming-yield">
                    üå± –¢–µ–∫—É—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Ñ–∞—Ä–º–∏–Ω–≥–∞
                </button>
                <button class="scenario-btn" data-scenario="token-info">
                    üíé –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–∫–µ–Ω–µ SHROOMS
                </button>
                <button class="scenario-btn" data-scenario="technical-problem">
                    üêõ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞)
                </button>
                <button class="scenario-btn" data-scenario="off-topic">
                    ‚ùå Off-topic –≤–æ–ø—Ä–æ—Å (–±–µ–∑ RAG)
                </button>
                <button class="scenario-btn" data-scenario="multilang-test">
                    üåç –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω—ã–π —Ç–µ—Å—Ç
                </button>
            </div>
        </div>

        <div class="main-grid">
            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div class="panel">
                <h2>üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
                
                <form id="chatForm">
                    <div class="input-group">
                        <label for="messageInput">–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
                        <textarea 
                            id="messageInput" 
                            name="message"
                            class="message-input" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∑–¥–µ—Å—å..."
                            required
                        ></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="userIdInput">User ID:</label>
                        <input 
                            type="text" 
                            id="userIdInput"
                            name="userId"
                            class="message-input" 
                            value="test-rag-user"
                            style="height: auto; min-height: auto;"
                            required
                        >
                    </div>
                    
                    <button type="submit" class="send-btn" id="sendBtn">
                        üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    </button>
                </form>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ -->
            <div class="panel">
                <h2>ü§ñ –û—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</h2>
                <div class="response-area" id="responseArea">
                    <div class="message assistant">
                        <div class="message-meta">üçÑ –ì—Ä–∏–±–Ω–æ–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
                        <div>–ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ Shrooms. –í—ã–±–µ—Ä–∏ —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –≤—ã—à–µ –∏–ª–∏ –∑–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * @typedef {Object} ChatMessage
         * @property {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
         * @property {string} userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         * @property {string} [conversationId] - ID —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
         * @property {string} [language] - –Ø–∑—ã–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
         */

        /**
         * @typedef {Object} ChatResponse
         * @property {boolean} success - –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
         * @property {Object} data - –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
         * @property {string} data.response - –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
         * @property {string} data.conversationId - ID —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
         * @property {boolean} data.ticketCreated - –°–æ–∑–¥–∞–Ω –ª–∏ —Ç–∏–∫–µ—Ç
         * @property {string} [data.ticketId] - ID —Ç–∏–∫–µ—Ç–∞
         * @property {Object} [data.ragAnalysis] - –ê–Ω–∞–ª–∏–∑ RAG
         * @property {Array} [data.ragAnalysis.foundDocuments] - –ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
         * @property {number} [data.ragAnalysis.searchTime] - –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞
         * @property {number} data.responseTime - –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
         */

        class RAGTestInterface {
            constructor() {
                this.currentLanguage = 'ru';
                this.conversationId = null;
                this.metrics = {
                    totalQueries: 0,
                    totalResponseTime: 0,
                    ragHits: 0,
                    totalDocsFound: 0
                };
                this.scenarios = this.initializeScenarios();
                this.initializeEventListeners();
            }

            /**
             * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
             * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è–∑—ã–∫–∞
             */
            initializeScenarios() {
                return {
                    ru: {
                        'wallet-connection': '–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫ Xverse –∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Shrooms?',
                        'farming-yield': '–ö–∞–∫–∞—è —Å–µ–π—á–∞—Å –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Ñ–∞—Ä–º–∏–Ω–≥–∞ SHROOMS?',
                        'token-info': '–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ —Ç–æ–∫–µ–Ω SHROOMS –∏ –µ–≥–æ —Ç–æ–∫–µ–Ω–æ–º–∏–∫—É',
                        'technical-problem': '–£ –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º–∞: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏—Å–∏—Ç —É–∂–µ 2 —á–∞—Å–∞ –∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è',
                        'off-topic': '–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è –≤ –ú–æ—Å–∫–≤–µ?',
                        'multilang-test': '–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã'
                    },
                    en: {
                        'wallet-connection': 'How do I connect Xverse wallet to Shrooms platform?',
                        'farming-yield': 'What is the current SHROOMS farming yield?',
                        'token-info': 'Tell me about SHROOMS token and its tokenomics',
                        'technical-problem': 'I have a problem: my transaction is stuck for 2 hours',
                        'off-topic': 'What\'s the weather like in Moscow today?',
                        'multilang-test': 'Testing system multilingual capabilities'
                    },
                    es: {
                        'wallet-connection': '¬øC√≥mo conecto la billetera Xverse a la plataforma Shrooms?',
                        'farming-yield': '¬øCu√°l es el rendimiento actual del farming de SHROOMS?',
                        'token-info': 'Cu√©ntame sobre el token SHROOMS y su token√≥mica',
                        'technical-problem': 'Tengo un problema: mi transacci√≥n est√° atascada desde hace 2 horas',
                        'off-topic': '¬øQu√© tiempo hace hoy en Mosc√∫?',
                        'multilang-test': 'Probando las capacidades multiling√ºes del sistema'
                    }
                };
            }

            /**
             * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
             */
            initializeEventListeners() {
                // –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                document.getElementById('chatForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });

                // –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.switchLanguage(btn.dataset.lang);
                    });
                });

                // –ö–Ω–æ–ø–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
                document.querySelectorAll('.scenario-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.loadScenario(btn.dataset.scenario);
                    });
                });
            }

            /**
             * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
             * @param {string} lang - –ö–æ–¥ —è–∑—ã–∫–∞
             */
            switchLanguage(lang) {
                this.currentLanguage = lang;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.lang === lang);
                });

                console.log(`üåç –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω —è–∑—ã–∫: ${lang}`);
            }

            /**
             * –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
             * @param {string} scenarioKey - –ö–ª—é—á —Å—Ü–µ–Ω–∞—Ä–∏—è
             */
            loadScenario(scenarioKey) {
                const scenario = this.scenarios[this.currentLanguage][scenarioKey];
                if (scenario) {
                    document.getElementById('messageInput').value = scenario;
                    console.log(`üß™ –ó–∞–≥—Ä—É–∂–µ–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π: ${scenarioKey} (${this.currentLanguage})`);
                }
            }

            /**
             * –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
             */
            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const userIdInput = document.getElementById('userIdInput');
                const sendBtn = document.getElementById('sendBtn');
                
                const message = messageInput.value.trim();
                const userId = userIdInput.value.trim();

                if (!message || !userId) {
                    this.showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }

                // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏
                sendBtn.disabled = true;
                sendBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

                try {
                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    this.addMessage('user', message);

                    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                    const requestData = {
                        message,
                        userId,
                        language: this.currentLanguage
                    };

                    if (this.conversationId) {
                        requestData.conversationId = this.conversationId;
                    }

                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
                    const startTime = Date.now();
                    const response = await this.sendChatRequest(requestData);
                    const responseTime = Date.now() - startTime;

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
                    this.handleChatResponse(response, responseTime);
                    
                    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
                    messageInput.value = '';

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    this.showError(`–û—à–∏–±–∫–∞: ${error.message}`);
                } finally {
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
                }
            }

            /**
             * –û—Ç–ø—Ä–∞–≤–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞ –∫ Chat API
             * @param {ChatMessage} requestData - –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞
             * @returns {Promise<ChatResponse>} –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
             */
            async sendChatRequest(requestData) {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            }

            /**
             * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Chat API
             * @param {ChatResponse} response - –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
             * @param {number} responseTime - –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤ –º—Å
             */
            handleChatResponse(response, responseTime) {
                if (!response.success) {
                    throw new Error(response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }

                const { data } = response;
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ID —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
                if (data.conversationId) {
                    this.conversationId = data.conversationId;
                }

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                this.addMessage('assistant', data.response, {
                    ragAnalysis: data.ragAnalysis,
                    ticketCreated: data.ticketCreated,
                    ticketId: data.ticketId,
                    responseTime
                });

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
                this.updateMetrics(data, responseTime);
            }

            /**
             * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
             * @param {string} role - –†–æ–ª—å (user/assistant)
             * @param {string} content - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
             * @param {Object} meta - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
             */
            addMessage(role, content, meta = {}) {
                const responseArea = document.getElementById('responseArea');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;

                let messageHTML = '';
                
                // –ú–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                if (role === 'user') {
                    messageHTML += `<div class="message-meta">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (${new Date().toLocaleTimeString()})</div>`;
                } else {
                    const timeInfo = meta.responseTime ? ` ‚Ä¢ ${meta.responseTime}ms` : '';
                    messageHTML += `<div class="message-meta">ü§ñ –ì—Ä–∏–±–Ω–æ–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ (${new Date().toLocaleTimeString()}${timeInfo})</div>`;
                }

                // –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                messageHTML += `<div>${this.formatMessageContent(content)}</div>`;

                // RAG –∞–Ω–∞–ª–∏–∑ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
                if (role === 'assistant' && meta.ragAnalysis) {
                    messageHTML += this.formatRAGAnalysis(meta.ragAnalysis);
                }

                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–∫–µ—Ç–µ
                if (meta.ticketCreated && meta.ticketId) {
                    messageHTML += `<div class="rag-analysis">
                        <h4>üé´ –°–æ–∑–¥–∞–Ω —Ç–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h4>
                        <p>ID —Ç–∏–∫–µ—Ç–∞: <strong>${meta.ticketId}</strong></p>
                    </div>`;
                }

                messageDiv.innerHTML = messageHTML;
                responseArea.appendChild(messageDiv);
                
                // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                responseArea.scrollTop = responseArea.scrollHeight;
            }

            /**
             * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
             * @param {string} content - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
             * @returns {string} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML
             */
            formatMessageContent(content) {
                return content
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
            }

            /**
             * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RAG –∞–Ω–∞–ª–∏–∑–∞
             * @param {Object} ragAnalysis - –î–∞–Ω–Ω—ã–µ RAG –∞–Ω–∞–ª–∏–∑–∞
             * @returns {string} HTML –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
             */
            formatRAGAnalysis(ragAnalysis) {
                if (!ragAnalysis || !ragAnalysis.foundDocuments || ragAnalysis.foundDocuments.length === 0) {
                    return `<div class="rag-analysis">
                        <h4>üß† RAG –ê–Ω–∞–ª–∏–∑</h4>
                        <p>‚ùå –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    </div>`;
                }

                let html = `<div class="rag-analysis">
                    <h4>üß† RAG –ê–Ω–∞–ª–∏–∑</h4>
                    <p>‚úÖ –ù–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${ragAnalysis.foundDocuments.length}</p>`;
                
                if (ragAnalysis.searchTime) {
                    html += `<p>‚è±Ô∏è –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞: ${ragAnalysis.searchTime}ms</p>`;
                }

                html += '<div class="found-docs">';
                ragAnalysis.foundDocuments.forEach((doc, index) => {
                    const score = doc.score ? ` (${(doc.score * 100).toFixed(1)}%)` : '';
                    html += `<div class="doc-item">
                        <strong>${index + 1}. ${doc.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>${score}
                        <div style="font-size: 0.8em; opacity: 0.7;">
                            ${doc.category || '–û–±—â–µ–µ'} ‚Ä¢ ${doc.language || 'unknown'}
                        </div>
                    </div>`;
                });
                html += '</div></div>';

                return html;
            }

            /**
             * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
             * @param {Object} data - –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
             * @param {number} responseTime - –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
             */
            updateMetrics(data, responseTime) {
                this.metrics.totalQueries++;
                this.metrics.totalResponseTime += responseTime;
                
                if (data.ragAnalysis && data.ragAnalysis.foundDocuments && data.ragAnalysis.foundDocuments.length > 0) {
                    this.metrics.ragHits++;
                    this.metrics.totalDocsFound += data.ragAnalysis.foundDocuments.length;
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                document.getElementById('totalQueries').textContent = this.metrics.totalQueries;
                document.getElementById('avgResponseTime').textContent = 
                    Math.round(this.metrics.totalResponseTime / this.metrics.totalQueries) + 'ms';
                document.getElementById('ragHitRate').textContent = 
                    Math.round((this.metrics.ragHits / this.metrics.totalQueries) * 100) + '%';
                document.getElementById('docsFound').textContent = this.metrics.totalDocsFound;
            }

            /**
             * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
             * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
             */
            showError(message) {
                const responseArea = document.getElementById('responseArea');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `<strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${message}`;
                responseArea.appendChild(errorDiv);
                responseArea.scrollTop = responseArea.scrollHeight;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            window.ragTestInterface = new RAGTestInterface();
            console.log('üçÑ RAG Test Interface –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        });
    </script>
</body>
</html>