/**
 * Prompt Service - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞–º–∏ –¥–ª—è Shrooms AI Support Bot
 * @file server/services/promptService.js
 * üçÑ –°–µ—Ä–≤–∏—Å –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞–º–∏ —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
 */

const Prompt = require('../models/prompt');
const logger = require('../utils/logger');

/**
 * @typedef {Object} CachedPrompt
 * @property {string} content - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–º–ø—Ç–∞
 * @property {number} maxTokens - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
 * @property {Date} cachedAt - –í—Ä–µ–º—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
 */

/**
 * @typedef {Object} PromptServiceConfig
 * @property {number} cacheTimeout - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç)
 * @property {boolean} enableFallback - –í–∫–ª—é—á–∏—Ç—å fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
 */

/**
 * @class PromptService
 * @description –°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞–º–∏ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ fallback —Å–∏—Å—Ç–µ–º–æ–π
 */
class PromptService {
  /**
   * @constructor
   * @param {PromptServiceConfig} [config] - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞
   */
  constructor(config = {}) {
    /** @type {Map<string, CachedPrompt>} */
    this.cache = new Map();
    
    /** @type {number} –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö */
    this.cacheTimeout = config.cacheTimeout || 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
    
    /** @type {boolean} –í–∫–ª—é—á–∏—Ç—å fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã */
    this.enableFallback = config.enableFallback !== false;
    
    /** @type {boolean} –§–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ */
    this.initialized = false;
    
    logger.info('üçÑ PromptService initialized with cache timeout:', this.cacheTimeout);
  }

  /**
   * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞
   * @returns {Promise<void>}
   */
  async initialize() {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –∏ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
      const promptCount = await Prompt.countDocuments();
      logger.info(`üçÑ Found ${promptCount} prompts in mushroom database`);
      
      this.initialized = true;
      logger.info('üçÑ PromptService mycelium network is ready!');
    } catch (error) {
      logger.error('üçÑ Failed to initialize PromptService:', error.message);
      if (this.enableFallback) {
        logger.warn('üçÑ Will use fallback prompts when needed');
      }
      throw error;
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ —Ç–∏–ø—É –∏ —è–∑—ã–∫—É –∏–∑ –ë–î –∏–ª–∏ –∫–µ—à–∞
   * @param {string} type - –¢–∏–ø –ø—Ä–æ–º–ø—Ç–∞ ('basic', 'rag', 'ticket_detection', 'categorization', 'subject')
   * @param {string} [language='en'] - –Ø–∑—ã–∫ –ø—Ä–æ–º–ø—Ç–∞ ('en', 'es', 'ru', 'all')
   * @returns {Promise<string>} –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–º–ø—Ç–∞
   */
  async getActivePrompt(type, language = 'en') {
    try {
      const cacheKey = `${type}_${language}`;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
      const cached = this.getCachedPrompt(cacheKey);
      if (cached) {
        logger.debug(`üçÑ Retrieved prompt from spore cache: ${cacheKey}`);
        return cached.content;
      }

      // –ò—â–µ–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      const prompt = await Prompt.getActivePrompt(type, language);
      
      if (prompt) {
        // –ö–µ—à–∏—Ä—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        this.setCachedPrompt(cacheKey, {
          content: prompt.content,
          maxTokens: prompt.maxTokens,
          cachedAt: new Date()
        });
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        try {
          await prompt.incrementUsage();
        } catch (usageError) {
          logger.warn('üçÑ Failed to increment prompt usage:', usageError.message);
        }
        
        logger.info(`üçÑ Retrieved active prompt from mushroom database: ${prompt.name}`);
        return prompt.content;
      }

      // –ï—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç –ø—Ä–æ–º–ø—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
      if (this.enableFallback) {
        logger.warn(`üçÑ No active prompt found in database, using fallback spores: ${type}/${language}`);
        return this.getDefaultPrompt(type, language);
      }

      throw new Error(`No active prompt found for type: ${type}, language: ${language}`);
    } catch (error) {
      logger.error(`üçÑ Error getting active prompt (${type}/${language}):`, error.message);
      
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback
      if (this.enableFallback) {
        logger.warn('üçÑ Database error, falling back to default spores');
        return this.getDefaultPrompt(type, language);
      }
      
      throw error;
    }
  }

  /**
   * Fallback –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –µ—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
   * @param {string} type - –¢–∏–ø –ø—Ä–æ–º–ø—Ç–∞
   * @param {string} [language='en'] - –Ø–∑—ã–∫ –ø—Ä–æ–º–ø—Ç–∞
   * @returns {string} –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç
   */
  getDefaultPrompt(type, language = 'en') {
    const fallbackPrompts = this._getFallbackPrompts();
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —è–∑—ã–∫
    const normalizedLanguage = ['en', 'es', 'ru'].includes(language) ? language : 'en';
    
    switch (type) {
      case 'basic':
        return fallbackPrompts.basic[normalizedLanguage];
      case 'rag':
        return `${fallbackPrompts.basic[normalizedLanguage]}\n\n${fallbackPrompts.rag[normalizedLanguage]}`;
      case 'ticket_detection':
        return fallbackPrompts.ticketDetection;
      case 'categorization':
        return fallbackPrompts.categorization;
      case 'subject':
        return fallbackPrompts.subject;
      default:
        logger.warn(`üçÑ Unknown prompt type for fallback: ${type}, using basic`);
        return fallbackPrompts.basic[normalizedLanguage];
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
   * @param {string} key - –ö–ª—é—á –∫–µ—à–∞
   * @returns {CachedPrompt|null} –ó–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–ª–∏ null
   */
  getCachedPrompt(key) {
    const cached = this.cache.get(key);
    
    if (!cached) {
      return null;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª –ª–∏ –∫–µ—à
    const now = new Date();
    const cacheAge = now.getTime() - cached.cachedAt.getTime();
    
    if (cacheAge > this.cacheTimeout) {
      this.cache.delete(key);
      logger.debug(`üçÑ Expired cache entry removed: ${key}`);
      return null;
    }
    
    return cached;
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç –≤ –∫–µ—à
   * @param {string} key - –ö–ª—é—á –∫–µ—à–∞
   * @param {CachedPrompt} value - –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
   */
  setCachedPrompt(key, value) {
    this.cache.set(key, value);
    logger.debug(`üçÑ Cached prompt spore: ${key}`);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–µ—à–∞
    if (this.cache.size > 50) {
      // –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π —ç–ª–µ–º–µ–Ω—Ç
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
      logger.debug(`üçÑ Cache limit reached, removed oldest spore: ${firstKey}`);
    }
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–µ—à
   */
  clearCache() {
    const size = this.cache.size;
    this.cache.clear();
    logger.info(`üçÑ Cleared ${size} cached prompt spores from mycelium memory`);
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞/—è–∑—ã–∫–∞
   * @param {string} type - –¢–∏–ø –ø—Ä–æ–º–ø—Ç–∞
   * @param {string} [language] - –Ø–∑—ã–∫ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –æ—á–∏—â–∞—é—Ç—Å—è –≤—Å–µ —è–∑—ã–∫–∏ –¥–ª—è —Ç–∏–ø–∞)
   */
  clearCacheForType(type, language = null) {
    if (language) {
      const key = `${type}_${language}`;
      const deleted = this.cache.delete(key);
      if (deleted) {
        logger.info(`üçÑ Cleared cached spore: ${key}`);
      }
    } else {
      // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–æ–º–ø—Ç—ã –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
      const keysToDelete = [];
      for (const key of this.cache.keys()) {
        if (key.startsWith(`${type}_`)) {
          keysToDelete.push(key);
        }
      }
      
      keysToDelete.forEach(key => this.cache.delete(key));
      logger.info(`üçÑ Cleared ${keysToDelete.length} cached spores for type: ${type}`);
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–µ—à–∞
   * @returns {Object} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞
   */
  getCacheStats() {
    const stats = {
      totalCached: this.cache.size,
      cacheTimeout: this.cacheTimeout,
      entries: []
    };

    for (const [key, value] of this.cache.entries()) {
      const age = new Date().getTime() - value.cachedAt.getTime();
      stats.entries.push({
        key,
        ageMs: age,
        contentLength: value.content.length,
        maxTokens: value.maxTokens
      });
    }

    return stats;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞
   * @returns {Promise<Object>} –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
   */
  async diagnose() {
    const diagnosis = {
      service: 'PromptService',
      status: 'unknown',
      initialized: this.initialized,
      cacheStats: this.getCacheStats(),
      databaseConnection: false,
      promptCounts: {},
      lastError: null
    };

    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
      const totalPrompts = await Prompt.countDocuments();
      diagnosis.databaseConnection = true;
      
      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–º–ø—Ç–æ–≤
      diagnosis.promptCounts = await Prompt.getStats();
      
      // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
      const testPrompt = await this.getActivePrompt('basic', 'en');
      
      if (testPrompt && testPrompt.length > 0) {
        diagnosis.status = 'healthy';
      } else {
        diagnosis.status = 'warning';
        diagnosis.lastError = 'Retrieved empty prompt content';
      }
      
    } catch (error) {
      diagnosis.status = 'error';
      diagnosis.lastError = error.message;
    }

    return diagnosis;
  }

  /**
   * –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ fallback –ø—Ä–æ–º–ø—Ç—ã –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î
   * @private
   * @returns {Object} –û–±—ä–µ–∫—Ç —Å fallback –ø—Ä–æ–º–ø—Ç–∞–º–∏
   */
  _getFallbackPrompts() {
    return {
      basic: {
        en: "You are Sporus, AI assistant for Shrooms Web3 platform. Be helpful and friendly. You can only answer questions about the Shrooms project, wallet connections, farming, and technical support.",
        ru: "–¢—ã Sporus, –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Shrooms. –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º. –¢—ã –º–æ–∂–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–µ–∫—Ç–µ Shrooms, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–æ–≤, —Ñ–∞—Ä–º–∏–Ω–≥–µ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–µ.",
        es: "Eres Sporus, asistente IA para la plataforma Shrooms. S√© √∫til y amigable. Solo puedes responder preguntas sobre el proyecto Shrooms, conexiones de billetera, farming y soporte t√©cnico."
      },
      rag: {
        en: "Use ONLY the information provided in the context to answer user questions about the Shrooms project. If context is insufficient, suggest creating a support ticket.",
        ru: "–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–µ–∫—Ç–µ Shrooms. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏.",
        es: "Usa SOLO la informaci√≥n proporcionada en el contexto para responder preguntas sobre el proyecto Shrooms. Si el contexto es insuficiente, sugiere crear un ticket de soporte."
      },
      ticketDetection: "Analyze the user message and determine if a support ticket needs to be created. Respond only with 'YES' or 'NO'.",
      categorization: "Categorize the support ticket based on the problem description. Categories: technical, account, billing, feature, other. Priorities: urgent, high, medium, low.",
      subject: "Generate a brief, informative subject for the support ticket based on the user's message. Maximum 60 characters."
    };
  }
}

// –°–æ–∑–¥–∞–µ–º –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
const promptService = new PromptService({
  cacheTimeout: parseInt(process.env.PROMPT_CACHE_TIMEOUT) || 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  enableFallback: process.env.PROMPT_ENABLE_FALLBACK !== 'false'
});

module.exports = promptService;