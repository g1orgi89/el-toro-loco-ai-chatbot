<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shrooms AI Support Bot - CORS Tests</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #050505 0%, #121212 100%);
            color: #E0E0E0;
            line-height: 1.6;
            min-height: 100vh;
            background-attachment: fixed;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(18, 18, 18, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(57, 255, 20, 0.2);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(57, 255, 20, 0.1);
        }
        
        .header h1 {
            color: #39FF14;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(57, 255, 20, 0.5);
            font-weight: 700;
        }
        
        .header p {
            color: #8A2BE2;
            font-size: 1.2em;
        }
        
        .test-section {
            background: rgba(18, 18, 18, 0.9);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }
        
        .test-section h2 {
            color: #FF6EC7;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-shadow: 0 0 10px rgba(255, 110, 199, 0.3);
        }
        
        .button {
            background: linear-gradient(45deg, #39FF14, #00FF41);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 10px 10px 0;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(57, 255, 20, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(57, 255, 20, 0.5);
            background: linear-gradient(45deg, #00FF41, #39FF14);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button.auth {
            background: linear-gradient(45deg, #8A2BE2, #9A3BF2);
            color: #fff;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
        }
        
        .button.auth:hover {
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.5);
            background: linear-gradient(45deg, #9A3BF2, #8A2BE2);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            background: rgba(5, 5, 5, 0.8);
            border: 1px solid rgba(57, 255, 20, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Monaco', 'Consolas', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            color: #00FF41;
            font-size: 14px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            position: relative;
        }
        
        .status-success {
            background: #39FF14;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.7);
        }
        
        .status-error {
            background: #FF6B6B;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.7);
        }
        
        .status-pending {
            background: #FFD93D;
            box-shadow: 0 0 10px rgba(255, 217, 61, 0.7);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.9); }
        }
        
        .credentials-form {
            background: rgba(5, 5, 5, 0.5);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            color: #FF6EC7;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(57, 255, 20, 0.3);
            border-radius: 5px;
            background: rgba(18, 18, 18, 0.8);
            color: #E0E0E0;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #39FF14;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.3);
        }
        
        .mushroom-logo {
            font-size: 3em;
            margin-bottom: 20px;
        }
        
        .debug-info {
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            color: #8A2BE2;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .button {
                width: 100%;
                margin-bottom: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="mushroom-logo">üçÑ</div>
            <h1>Shrooms AI Support Bot</h1>
            <p>CORS & Authentication Testing Dashboard</p>
        </div>

        <div class="test-section">
            <h2>üîì Public Endpoints (No CORS restrictions)</h2>
            <button class="button" onclick="testPublicEndpoint('/api/health')" id="health-btn">
                <span id="health-status" class="status-indicator"></span>
                Test Health Check
            </button>
            <button class="button" onclick="testPublicEndpoint('/api/chat/message')" id="chat-btn">
                <span id="chat-status" class="status-indicator"></span>
                Test Chat Message (POST)
            </button>
            <div id="public-results" class="results">Console will show test results here...</div>
        </div>

        <div class="test-section">
            <h2>üîê Admin Authentication</h2>
            <div class="credentials-form">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" value="admin" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" value="password123" placeholder="Enter password">
                </div>
            </div>
            <button class="button auth" onclick="testAuthEndpoint('/api/admin/tickets')" id="auth-get-btn">
                <span id="auth-tickets-status" class="status-indicator"></span>
                Test Admin Tickets (GET)
            </button>
            <button class="button auth" onclick="testAuthEndpoint('/api/admin/tickets', 'POST')" id="auth-post-btn">
                <span id="auth-post-status" class="status-indicator"></span>
                Test Create Admin Resource (POST)
            </button>
            <div id="auth-results" class="results">Console will show auth test results here...</div>
        </div>

        <div class="test-section">
            <h2>üìä Rate Limiting Tests</h2>
            <button class="button" onclick="testRateLimit()" id="rate-limit-btn">
                <span id="rate-limit-status" class="status-indicator"></span>
                Test Rate Limiting (10 rapid requests)
            </button>
            <div id="rate-limit-results" class="results">Console will show rate limit test results here...</div>
        </div>

        <div class="test-section">
            <h2>üåê Cross-Origin Tests</h2>
            <button class="button" onclick="testCORSPreflight()" id="cors-preflight-btn">
                <span id="cors-preflight-status" class="status-indicator"></span>
                Test CORS Preflight
            </button>
            <button class="button" onclick="testCORSCredentials()" id="cors-credentials-btn">
                <span id="cors-credentials-status" class="status-indicator"></span>
                Test CORS with Credentials
            </button>
            <div id="cors-results" class="results">Console will show CORS test results here...</div>
        </div>

        <div class="debug-info">
            <strong>Debug Info:</strong><br>
            Current URL: <span id="current-url"></span><br>
            User Agent: <span id="user-agent"></span><br>
            JS Enabled: ‚úì
        </div>
    </div>

    <script>
        // Set debug info
        document.getElementById('current-url').textContent = window.location.href;
        document.getElementById('user-agent').textContent = navigator.userAgent;
        
        // Global variables
        const baseURL = window.location.origin;
        
        // Log function to show activity
        function log(message) {
            console.log(`[CORS Test] ${message}`);
        }
        
        // Utility function to update status indicators
        function updateStatus(elementId, status) {
            log(`Updating status ${elementId}: ${status}`);
            const indicator = document.getElementById(elementId);
            if (!indicator) {
                log(`Warning: Status indicator ${elementId} not found`);
                return;
            }
            
            indicator.className = 'status-indicator';
            if (status === 'pending') {
                indicator.classList.add('status-pending');
            } else if (status === 'success') {
                indicator.classList.add('status-success');
            } else if (status === 'error') {
                indicator.classList.add('status-error');
            }
        }
        
        // Test public endpoints
        async function testPublicEndpoint(endpoint) {
            const statusId = endpoint.includes('health') ? 'health-status' : 'chat-status';
            const btnId = endpoint.includes('health') ? 'health-btn' : 'chat-btn';
            
            log(`Testing public endpoint: ${endpoint}`);
            updateStatus(statusId, 'pending');
            
            // Disable button during test
            const button = document.getElementById(btnId);
            button.disabled = true;
            
            const results = document.getElementById('public-results');
            const timestamp = new Date().toLocaleTimeString();
            
            try {
                let options = { method: 'GET' };
                
                if (endpoint.includes('chat')) {
                    options = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Origin': 'http://test-cors.example.com'
                        },
                        body: JSON.stringify({
                            message: 'Hello from CORS test! üçÑ',
                            userId: 'test-user-cors',
                            language: 'en'
                        })
                    };
                }
                
                log(`Making request to ${baseURL + endpoint}`);
                const response = await fetch(baseURL + endpoint, options);
                const data = await response.json();
                
                updateStatus(statusId, response.ok ? 'success' : 'error');
                
                results.textContent += `[${timestamp}] ${endpoint} (${options.method})\n`;
                results.textContent += `Status: ${response.status} ${response.statusText}\n`;
                
                // Show important headers
                const corsHeaders = {};
                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().startsWith('access-control-') || key.toLowerCase().includes('cors')) {
                        corsHeaders[key] = value;
                    }
                });
                
                if (Object.keys(corsHeaders).length > 0) {
                    results.textContent += `CORS Headers: ${JSON.stringify(corsHeaders, null, 2)}\n`;
                }
                
                results.textContent += `Response: ${JSON.stringify(data, null, 2)}\n\n`;
                results.scrollTop = results.scrollHeight;
                
            } catch (error) {
                log(`Error in testPublicEndpoint: ${error.message}`);
                updateStatus(statusId, 'error');
                results.textContent += `[${timestamp}] ${endpoint} - ERROR\n`;
                results.textContent += `Error: ${error.message}\n\n`;
                results.scrollTop = results.scrollHeight;
            } finally {
                // Re-enable button
                button.disabled = false;
            }
        }
        
        // Test authenticated endpoints
        async function testAuthEndpoint(endpoint, method = 'GET') {
            const statusId = method === 'POST' ? 'auth-post-status' : 'auth-tickets-status';
            const btnId = method === 'POST' ? 'auth-post-btn' : 'auth-get-btn';
            
            log(`Testing auth endpoint: ${endpoint} (${method})`);
            updateStatus(statusId, 'pending');
            
            // Disable button during test
            const button = document.getElementById(btnId);
            button.disabled = true;
            
            const results = document.getElementById('auth-results');
            const timestamp = new Date().toLocaleTimeString();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const options = {
                    method: method,
                    headers: {
                        'Authorization': 'Basic ' + btoa(username + ':' + password),
                        'Content-Type': 'application/json',
                        'Origin': 'http://test-cors.example.com'
                    }
                };
                
                if (method === 'POST') {
                    options.body = JSON.stringify({
                        title: 'Test ticket from CORS',
                        description: 'Testing admin endpoint with CORS üçÑ',
                        priority: 'low'
                    });
                }
                
                log(`Making authenticated request to ${baseURL + endpoint}`);
                const response = await fetch(baseURL + endpoint, options);
                const data = await response.json();
                
                updateStatus(statusId, response.ok ? 'success' : 'error');
                
                results.textContent += `[${timestamp}] ${endpoint} (${method})\n`;
                results.textContent += `Credentials: ${username}:${password.replace(/./g, '*')}\n`;
                results.textContent += `Status: ${response.status} ${response.statusText}\n`;
                
                // Show auth-related headers
                const authHeaders = {};
                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().includes('auth') || key.toLowerCase().startsWith('access-control-')) {
                        authHeaders[key] = value;
                    }
                });
                
                if (Object.keys(authHeaders).length > 0) {
                    results.textContent += `Auth/CORS Headers: ${JSON.stringify(authHeaders, null, 2)}\n`;
                }
                
                results.textContent += `Response: ${JSON.stringify(data, null, 2)}\n\n`;
                results.scrollTop = results.scrollHeight;
                
            } catch (error) {
                log(`Error in testAuthEndpoint: ${error.message}`);
                updateStatus(statusId, 'error');
                results.textContent += `[${timestamp}] ${endpoint} (${method}) - ERROR\n`;
                results.textContent += `Error: ${error.message}\n\n`;
                results.scrollTop = results.scrollHeight;
            } finally {
                // Re-enable button
                button.disabled = false;
            }
        }
        
        // Test rate limiting
        async function testRateLimit() {
            log('Starting rate limit test');
            updateStatus('rate-limit-status', 'pending');
            
            // Disable button during test
            const button = document.getElementById('rate-limit-btn');
            button.disabled = true;
            
            const results = document.getElementById('rate-limit-results');
            const timestamp = new Date().toLocaleTimeString();
            
            results.textContent += `[${timestamp}] Starting rate limit test (10 rapid requests)...\n`;
            
            try {
                const promises = [];
                for (let i = 0; i < 10; i++) {
                    promises.push(
                        fetch(baseURL + '/api/health')
                            .then(response => ({
                                request: i + 1,
                                status: response.status,
                                headers: {
                                    'x-ratelimit-limit': response.headers.get('x-ratelimit-limit'),
                                    'x-ratelimit-remaining': response.headers.get('x-ratelimit-remaining'),
                                    'x-ratelimit-reset': response.headers.get('x-ratelimit-reset'),
                                    'retry-after': response.headers.get('retry-after')
                                }
                            }))
                            .catch(error => ({
                                request: i + 1,
                                error: error.message
                            }))
                    );
                }
                
                const responses = await Promise.all(promises);
                let rateLimited = false;
                
                responses.forEach(resp => {
                    results.textContent += `Request ${resp.request}: `;
                    if (resp.error) {
                        results.textContent += `ERROR - ${resp.error}\n`;
                    } else {
                        results.textContent += `Status ${resp.status}`;
                        if (resp.status === 429) {
                            rateLimited = true;
                            results.textContent += ` (Rate Limited!)`;
                            if (resp.headers['retry-after']) {
                                results.textContent += ` - Retry after: ${resp.headers['retry-after']}s`;
                            }
                        }
                        if (resp.headers['x-ratelimit-remaining']) {
                            results.textContent += ` - Remaining: ${resp.headers['x-ratelimit-remaining']}`;
                        }
                        results.textContent += `\n`;
                    }
                });
                
                updateStatus('rate-limit-status', rateLimited ? 'success' : 'error');
                results.textContent += `\nRate limiting is ${rateLimited ? 'WORKING ‚úì' : 'NOT WORKING ‚úó'}\n\n`;
                results.scrollTop = results.scrollHeight;
                
            } catch (error) {
                log(`Error in testRateLimit: ${error.message}`);
                updateStatus('rate-limit-status', 'error');
                results.textContent += `Rate limit test failed: ${error.message}\n\n`;
                results.scrollTop = results.scrollHeight;
            } finally {
                // Re-enable button
                button.disabled = false;
            }
        }
        
        // Test CORS preflight
        async function testCORSPreflight() {
            log('Testing CORS preflight');
            updateStatus('cors-preflight-status', 'pending');
            
            // Disable button during test
            const button = document.getElementById('cors-preflight-btn');
            button.disabled = true;
            
            const results = document.getElementById('cors-results');
            const timestamp = new Date().toLocaleTimeString();
            
            try {
                // Note: Browser will automatically send OPTIONS request for preflight
                const response = await fetch(baseURL + '/api/admin/tickets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://test-cors.example.com',
                        'Authorization': 'Basic ' + btoa('admin:password123')
                    },
                    body: JSON.stringify({ test: 'preflight' })
                });
                
                updateStatus('cors-preflight-status', response.ok || response.status === 401 ? 'success' : 'error');
                
                results.textContent += `[${timestamp}] CORS Preflight Test\n`;
                results.textContent += `Status: ${response.status} ${response.statusText}\n`;
                results.textContent += `Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin') || 'Not set'}\n`;
                results.textContent += `Access-Control-Allow-Methods: ${response.headers.get('Access-Control-Allow-Methods') || 'Not set'}\n`;
                results.textContent += `Access-Control-Allow-Headers: ${response.headers.get('Access-Control-Allow-Headers') || 'Not set'}\n`;
                results.textContent += `Access-Control-Allow-Credentials: ${response.headers.get('Access-Control-Allow-Credentials') || 'Not set'}\n\n`;
                results.scrollTop = results.scrollHeight;
                
            } catch (error) {
                log(`Error in testCORSPreflight: ${error.message}`);
                updateStatus('cors-preflight-status', 'error');
                results.textContent += `[${timestamp}] CORS Preflight - ERROR\n`;
                results.textContent += `Error: ${error.message}\n\n`;
                results.scrollTop = results.scrollHeight;
            } finally {
                // Re-enable button
                button.disabled = false;
            }
        }
        
        // Test CORS with credentials
        async function testCORSCredentials() {
            log('Testing CORS with credentials');
            updateStatus('cors-credentials-status', 'pending');
            
            // Disable button during test
            const button = document.getElementById('cors-credentials-btn');
            button.disabled = true;
            
            const results = document.getElementById('cors-results');
            const timestamp = new Date().toLocaleTimeString();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(baseURL + '/api/admin/tickets', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Basic ' + btoa(username + ':' + password),
                        'Origin': 'http://test-cors.example.com'
                    }
                });
                
                const data = await response.json();
                
                updateStatus('cors-credentials-status', response.ok ? 'success' : 'error');
                
                results.textContent += `[${timestamp}] CORS with Credentials Test\n`;
                results.textContent += `Status: ${response.status} ${response.statusText}\n`;
                results.textContent += `Access-Control-Allow-Credentials: ${response.headers.get('Access-Control-Allow-Credentials') || 'Not set'}\n`;
                results.textContent += `Response: ${JSON.stringify(data, null, 2)}\n\n`;
                results.scrollTop = results.scrollHeight;
                
            } catch (error) {
                log(`Error in testCORSCredentials: ${error.message}`);
                updateStatus('cors-credentials-status', 'error');
                results.textContent += `[${timestamp}] CORS with Credentials - ERROR\n`;
                results.textContent += `Error: ${error.message}\n\n`;
                results.scrollTop = results.scrollHeight;
            } finally {
                // Re-enable button
                button.disabled = false;
            }
        }
        
        // Auto-run health check on page load
        window.addEventListener('load', () => {
            log('Page loaded, running initial health check');
            setTimeout(() => {
                testPublicEndpoint('/api/health');
            }, 1000);
        });
        
        // Log any JavaScript errors
        window.addEventListener('error', (event) => {
            log(`JavaScript Error: ${event.error.message}`);
            console.error('JavaScript Error:', event.error);
        });
        
        // Test if buttons are working
        log('CORS test page loaded successfully. JavaScript is working.');
    </script>
</body>
</html>